stages:
  - build
  - deploy

build-back:
  image: registry.gitlab.inria.fr/diverse/docker/docker-image/insa-maven:3.8-openjdk-17
  stage: build
  script:
    - cd game/game-backend
    - mvn clean package spring-boot:repackage
  rules:
    - changes:
      - "*.md"
      when: never
    - changes:
      - "game/game-backend/**/*"
      - ".gitlab-ci.yml"
      when: always
  artifacts:
    paths:
      - game/game-backend/target/site/jacoco/jacoco.xml
      - game/game-backend/target/game-backend-0.0.1.jar
    expire_in: 1 hour
    
build-front:
  image: registry.gitlab.inria.fr/diverse/docker/docker-image/insa-node:16.13.2
  stage: build
  cache:
    paths:
      - game/game-frontend/node_modules/
  script:
    - cd game/game-frontend
    - npm install
    #- npm run ng lint && npm run ng build -- --configuration production --build-optimizer
    #- npm run test
    #- npm run eslint
    - npm run ng build -- --configuration production --build-optimizer
  rules:
    - changes:
      - "*.md"
      when: never
    - changes:
      - "game/game-frontend/**/*"
      - ".gitlab-ci.yml"
      when: always
  artifacts:
    paths:
      - game/game-frontend/dist/game-frontend/
    expire_in: 1 hour

# build-job-docker:      
#   stage: build
#   script:
#     - echo "Docker login to INSA Repository..."
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD gitlab.insa-rennes.fr:5050 # Connexion to the INSA docker registry
#     - echo "Building Docker Image"
#     - docker build -t $CI_REGISTRY_IMAGE/test-devops/hello-world-build:latest . # build docker image
#     - echo "Building complete."
#     - docker push $CI_REGISTRY_IMAGE/test-devops/hello-world-build:latest # push docker image on the INSA Repository
#     - echo "Push on docker repository OK"

docker-back:
  image:
    name: gcr.io/kaniko-project/executor:v1.5.1-debug
    entrypoint: [""]
  stage: deploy
  rules:
    - changes:
      - "*.md"
      - "*.spec.ts"
      - "*/src/test/*"
      when: never
    - changes:
      - "game-backend/**/*"
      - ".gitlab-ci.yml"
      when: always
  dependencies:
    - build-back
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR/game-backend --dockerfile $CI_PROJECT_DIR/game-backend/Dockerfile --destination $CI_REGISTRY_IMAGE/game-back:latest


docker-front:
  image: gcr.io/kaniko-project/executor:v1.5.1-debug
  stage: deploy
  dependencies: 
    - build-front
  rules:
    - changes:
      - "*.md"
      - "*.spec.ts"
      - "*/src/test/*"
      when: never
    - changes:
      - "game-frontend/*"
      - ".gitlab-ci.yml"
      when: always
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR/game-frontend --dockerfile $CI_PROJECT_DIR/game-frontend/Dockerfile --destination $CI_REGISTRY_IMAGE/game-front:latest
